<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Mustang Island State Park Activities Locator</title>

    <link rel="icon" type="image/x-icon" href="img/BeachUmbrella2.png" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Momo+Trust+Display&family=Ranchers&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet" />

    <!-- Calcite Components -->
    <script src="https://js.arcgis.com/calcite-components/2.13.0/calcite.esm.js" type="module"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/2.13.0/calcite.css" />

    <!-- ArcGIS Maps SDK -->
    <script src="https://js.arcgis.com/4.30/"></script>

    <!-- Theme-swappable Esri stylesheet -->
    <link id="esri-theme" rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />

    <!-- Your external CSS file -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Remove Chrome favicon warning -->
    <link rel="icon" href="data:,">
</head>

<body>

    <!-- Loader -->
    <calcite-loader></calcite-loader>

    <calcite-shell content-behind hidden>

        <!-- HEADER -->
        <h2 id="header-title" slot="header">Mustang Island State Park Activities Locator</h2>

        <!-- LEFT PANEL -->
        <calcite-shell-panel slot="panel-start" display-mode="float">

            <calcite-action-bar slot="action-bar">

                <calcite-action data-action-id="about" icon="information" text="About this map"></calcite-action>
                <calcite-action data-action-id="theme" icon="brightness" text="Theme"></calcite-action>
                <calcite-action data-action-id="survey" icon="plus-circle" text="Add an Activity location"></calcite-action>
                <calcite-action data-action-id="legend" icon="legend" text="Show Legend"></calcite-action>

                <calcite-action data-action-id="layers" icon="layers" text="Select Layers"></calcite-action>
                <calcite-action data-action-id="basemaps" icon="basemap" text="Change Basemaps"></calcite-action>

                <!-- FILTER ACTION -->
                <calcite-action data-action-id="filter" icon="filter" text="Filter Layers"></calcite-action>

                <calcite-action data-action-id="search" icon="search" text="Search Nearby"></calcite-action>
                <calcite-action data-action-id="editor" icon="layers-editable" text="Open Editor"></calcite-action>
                <calcite-action data-action-id="credits" icon="credits" text="Source Credit"></calcite-action>
            </calcite-action-bar>

            <!-- LAYERS PANEL -->
            <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
                <div id="layers-container"></div>
            </calcite-panel>

            <!-- BASEMAP SWITCH PANEL -->
            <calcite-panel heading="Map style" height-scale="l" data-panel-id="basemaps" hidden>
                <div id="basemaps-container" style="padding: 0.75rem;">
                    <calcite-label layout="inline-space-between">
                        Map style
                        <calcite-segmented-control id="basemap-switch">
                            <calcite-segmented-control-item value="default" checked>
                                Original
                            </calcite-segmented-control-item>
                            <calcite-segmented-control-item value="imagery">Imagery & Roads</calcite-segmented-control-item>
                        </calcite-segmented-control>
                    </calcite-label>
                </div>
            </calcite-panel>

            <!-- FILTER PANEL -->
            <calcite-panel heading="Filter Layers" height-scale="l" data-panel-id="filter" hidden>
                <div style="padding: 0.75rem;">
                    <p class="my-paragraph">
                        Use quick filters to focus on specific types of points of interest.
                    </p>

                    <!-- Restroom filter button -->
                    <calcite-button id="restroom-filter-btn"
                                    width="full"
                                    appearance="outline"
                                    icon-start="filter">
                        Show Only Restrooms
                    </calcite-button>

                    <!-- Nearby filter button -->
                    <calcite-button id="nearby-filter-btn"
                                    width="full"
                                    appearance="outline"
                                    icon-start="gps-on"
                                    style="margin-top: 0.5rem;">
                        Show Within 1/2 Mile
                    </calcite-button>
                </div>
            </calcite-panel>

            <!-- LEGEND PANEL -->
            <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
                <div id="legend-container"></div>
            </calcite-panel>

            <!-- SEARCH PANEL -->
            <calcite-panel heading="Search Address nearby" height-scale="l" data-panel-id="search" hidden>
                <div id="search-container"></div>
            </calcite-panel>

            <!-- EDITOR -->
            <calcite-panel height-scale="l" data-panel-id="editor" hidden>
                <div id="editor-container"></div>
            </calcite-panel>

            <!-- ABOUT PANEL -->
            <calcite-panel height-scale="l" heading="About this map" data-panel-id="about" hidden>
                <div id="about-container">
                    <p class="my-paragraph">
                        This app is inspired by
                        <b><a href="https://tpwd.texas.gov/state-parks/mustang-island">Mustang Island State Park</a></b>
                        and
                        <b><a href="https://www.nps.gov/pais/index.htm">Padre Island National Seashore</a></b>.
                        The map shows kayaking, camping, and other outdoor activity locations in and around Mustang Island.

                        Use the action buttons on the left to explore the map, search for addresses nearby, and add your
                        locations!
                    </p>
                </div>
            </calcite-panel>

            <!-- THEME PANEL -->
            <calcite-panel height-scale="l" heading="App Theme" data-panel-id="theme" hidden>
                <div style="padding: 1.2rem;">
                    <calcite-label>
                        Light / Dark Mode
                        <calcite-switch id="theme-switch"></calcite-switch>
                    </calcite-label>
                </div>
            </calcite-panel>

            <!-- SURVEY PANEL -->
            <calcite-panel height-scale="l" heading="Add an Activity Point of Interest" data-panel-id="survey" hidden>
                <div id="survey-container">
                    <h4 style="margin-top:0; margin-left: 3%;">How To:</h4>
                    <p class="my-paragraph">Click the button to add your activity on the map and upload a picture.</p>
                    <div style="display:flex; margin: 1rem 1rem;">
                        <calcite-button href="https://survey123.arcgis.com/share/75c5a6775eb244eb8897001bd9035f20"
                            icon-end="launch" target="_blank" style="margin:auto;">
                            Open Activity Survey
                        </calcite-button>
                    </div>
                </div>
            </calcite-panel>

            <!-- CREDITS PANEL -->
            <calcite-panel height-scale="l" heading="Credits" data-panel-id="credits" hidden>
                <div id="credits-container">
                    <h4 style="margin-top:0; margin-left: 5%;">Many Thanks: Information Sources</h4>
                    <ol>
                        <li><a href="https://tpwd.texas.gov/state-parks/mustang-island">Mustang Island State Park</a></li>
                        <li><a href="https://www.nps.gov/pais/index.htm">Padre Island National Seashore</a></li>
                        <li><a href="https://tpwd.texas.gov/gis/">Texas Parks and Wildlife GIS</a></li>
                        <li><a href="https://tpwd.texas.gov/boating/paddling-trails/">Texas Paddling Trails</a></li>
                    </ol>
                </div>
            </calcite-panel>

        </calcite-shell-panel>

        <div id="viewDiv"></div>

    </calcite-shell>
</body>

<script>
    require([
        "esri/config",
        "esri/WebMap",
        "esri/views/MapView",
        "esri/widgets/LayerList",
        "esri/widgets/Legend",
        "esri/widgets/Search",
        "esri/widgets/Editor",
        "esri/widgets/Locate",
        "esri/widgets/Home",
        "esri/layers/FeatureLayer"
    ], function (
        esriConfig,
        WebMap,
        MapView,
        LayerList,
        Legend,
        Search,
        Editor,
        Locate,
        Home,
        FeatureLayer
    ) {

        const webmapId =
            new URLSearchParams(window.location.search).get("webmap") ??
            "c9da88aca51344ae9eb9764e6cca42df";

        esriConfig.apiKey =
            "AAPKfc7af196c6e64aac988bbf7529dccd648UR6aqr1HCuaJ5GN7OXourF3WZ9GF_b8R9-mMcrEZMHlZzpuLXHwt5iwInOA9k4J";

        const map = new WebMap({
            portalItem: { id: webmapId }
        });

        const view = new MapView({
            map,
            container: "viewDiv",
            padding: { left: 49 }
        });

        // Move zoom
        view.ui.move("zoom", "top-right");

        // Locate
        const locateWidget = new Locate({
            view: view,
            useHeadingEnabled: false
        });
        view.ui.add(locateWidget, { position: "top-right", index: 1 });

        // Home
        const homeWidget = new Home({ view: view });
        view.ui.add(homeWidget, { position: "top-right", index: 2 });

        // Basemap switch
        let originalBasemap;

        view.when(() => {
            originalBasemap = view.map.basemap;
            const basemapSwitch = document.getElementById("basemap-switch");

            basemapSwitch.addEventListener("calciteSegmentedControlChange", (event) => {
                const value = event.target.value;

                if (value === "default") {
                    view.map.basemap = originalBasemap;
                } else if (value === "imagery") {
                    view.map.basemap = "hybrid";
                }
            });
        });

        // Layer List
        new LayerList({ view: view, container: "layers-container" });

        // Legend
        new Legend({ view: view, container: "legend-container" });

        // Search
        new Search({ view: view, container: "search-container" });

        // Editor
        new Editor({
            view: view,
            container: "editor-container",
            visibleElements: { createFeaturesSection: false }
        });

        // Action bar logic
        map.when(() => {

            let activeWidget;

            const handleActionBarClick = ({ target }) => {
                if (target.tagName !== "CALCITE-ACTION") return;

                if (activeWidget) {
                    document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
                    document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
                }

                const nextWidget = target.dataset.actionId;

                if (nextWidget !== activeWidget) {
                    document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
                    document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
                    activeWidget = nextWidget;
                } else {
                    activeWidget = null;
                }
            };

            document.querySelector("calcite-action-bar")
                .addEventListener("click", handleActionBarClick);

            document.addEventListener("calciteActionBarToggle", () => {
                view.padding = {
                    left: view.padding.left === 49 ? 150 : 49
                };
            });

            document.querySelector("calcite-shell").hidden = false;
            document.querySelector("calcite-loader").hidden = true;

            // ------------------------------------------------------------
            // FILTER LOGIC - RESTROOM & NEARBY
            // ------------------------------------------------------------
            setTimeout(() => {
                console.log("=== LAYER DEBUG ===");
                console.log("All layers in map:", map.layers.map(l => l.title).toArray());
                
                const poiLayer = map.layers.find(layer => layer.title === "Points of Interest");
                const restroomBtn = document.getElementById("restroom-filter-btn");
                const nearbyBtn = document.getElementById("nearby-filter-btn");
                
                console.log("POI Layer found?", !!poiLayer);
                console.log("Restroom button found?", !!restroomBtn);
                console.log("Nearby button found?", !!nearbyBtn);
                
                if (poiLayer) {
                    poiLayer.when(() => {
                        console.log("POI Layer fields:", poiLayer.fields.map(f => f.name));
                        console.log("Current definition expression:", poiLayer.definitionExpression);
                    });
                }
                
                // RESTROOM FILTER
                if (poiLayer && restroomBtn) {
                    const possibleFilters = [
                        "p_picklist = 'Restroom'",
                        "p_picklist = 'restroom'",
                        "picklist = 'Restroom'",
                        "type = 'Restroom'",
                        "category = 'Restroom'"
                    ];
                    
                    const originalWhere = poiLayer.definitionExpression || "1=1";
                    let filterOn = false;
                    let currentFilterIndex = 0;
                    
                    restroomBtn.addEventListener("click", () => {
                        filterOn = !filterOn;
                        
                        if (filterOn) {
                            const filterToUse = possibleFilters[currentFilterIndex];
                            poiLayer.definitionExpression = filterToUse;
                            restroomBtn.textContent = "Show All POI";
                            restroomBtn.appearance = "solid";
                            console.log("Applied filter:", filterToUse);
                        } else {
                            poiLayer.definitionExpression = originalWhere;
                            restroomBtn.textContent = "Show Only Restrooms";
                            restroomBtn.appearance = "outline";
                            console.log("Filter removed");
                        }
                    });
                    
                    console.log("Restroom filter setup complete!");
                }
                
                // NEARBY (1/2 MILE BUFFER) FILTER
                if (poiLayer && nearbyBtn) {
                    let nearbyFilterOn = false;
                    
                    nearbyBtn.addEventListener("click", () => {
                        if (navigator.geolocation) {
                            nearbyBtn.loading = true;
                            
                            navigator.geolocation.getCurrentPosition(
                                (position) => {
                                    const { latitude, longitude } = position.coords;
                                    console.log("Got location:", latitude, longitude);
                                    
                                    // Create point geometry
                                    const userPoint = {
                                        type: "point",
                                        latitude: latitude,
                                        longitude: longitude,
                                        spatialReference: { wkid: 4326 }
                                    };
                                    
                                    // Use geometryEngine to create buffer (0.5 miles = 804.672 meters)
                                    require(["esri/geometry/geometryEngine"], (geometryEngine) => {
                                        const bufferGeometry = geometryEngine.geodesicBuffer(userPoint, 0.5, "miles");
                                        
                                        nearbyFilterOn = !nearbyFilterOn;
                                        
                                        if (nearbyFilterOn) {
                                            // Apply spatial filter
                                            poiLayer.featureEffect = {
                                                filter: {
                                                    geometry: bufferGeometry,
                                                    spatialRelationship: "intersects"
                                                },
                                                excludedEffect: "opacity(20%)"
                                            };
                                            nearbyBtn.textContent = "Show All POI";
                                            nearbyBtn.appearance = "solid";
                                            nearbyBtn.iconStart = "check-circle";
                                            console.log("Nearby filter applied");
                                        } else {
                                            poiLayer.featureEffect = null;
                                            nearbyBtn.textContent = "Show Within 1/2 Mile";
                                            nearbyBtn.appearance = "outline";
                                            nearbyBtn.iconStart = "gps-on";
                                            console.log("Nearby filter removed");
                                        }
                                        
                                        nearbyBtn.loading = false;
                                    });
                                },
                                (error) => {
                                    console.error("Location error:", error);
                                    alert("Could not get your location. Please enable location services.");
                                    nearbyBtn.loading = false;
                                }
                            );
                        } else {
                            alert("Geolocation is not supported by your browser.");
                        }
                    });
                    
                    console.log("Nearby filter setup complete!");
                }
                
            }, 1000);
        });

        // -----------------------------------------------------
        // LIGHT / DARK THEME SWITCH LOGIC
        // -----------------------------------------------------
        const themeSwitch = document.getElementById("theme-switch");
        const esriThemeLink = document.getElementById("esri-theme");

        function setTheme(mode) {
            const isDark = mode === "dark";

            document.body.classList.toggle("dark", isDark);
            document.body.classList.toggle("calcite-mode-dark", isDark);
            document.body.classList.toggle("calcite-mode-light", !isDark);

            esriThemeLink.href = isDark
                ? "https://js.arcgis.com/4.30/esri/themes/dark/main.css"
                : "https://js.arcgis.com/4.30/esri/themes/light/main.css";
        }

        if (themeSwitch) {
            themeSwitch.addEventListener("calciteSwitchChange", (event) => {
                setTheme(event.target.checked ? "dark" : "light");
            });
        }

        setTheme("light");
    });
</script>

</html>